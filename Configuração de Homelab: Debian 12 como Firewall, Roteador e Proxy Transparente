Configura√ß√£o de Homelab: Debian 12 como Firewall, Roteador e Proxy Transparente

Este reposit√≥rio documenta a configura√ß√£o de um servidor Debian 12 XFCE para funcionar como um n√≥ central em um homelab, atuando simultaneamente como firewall, roteador e proxy web transparente. Esta solu√ß√£o permite um controle robusto sobre o tr√°fego de rede, otimiza√ß√£o da navega√ß√£o via cache e a base para futuras implementa√ß√µes de seguran√ßa e filtragem de conte√∫do.
üéØ Objetivo do Projeto

O principal objetivo √© transformar uma m√°quina com Debian 12 XFCE em um gateway de rede completo para um homelab, providenciando:

    Roteamento de Tr√°fego: Conectar a rede local (LAN) √† internet (WAN).

    Seguran√ßa de Rede: Atuar como um firewall para proteger a rede interna.

    Otimiza√ß√£o de Acesso Web: Implementar um proxy de cache (Squid) para acelerar a navega√ß√£o e economizar largura de banda.

    Transpar√™ncia: Configurar o proxy de forma transparente, eliminando a necessidade de ajustes manuais nos dispositivos clientes.

üöÄ Componentes Utilizados

    Sistema Operacional: Debian 12 "Bookworm" (com ambiente de desktop XFCE)

    Firewall & Roteamento:

        UFW (Uncomplicated Firewall): Interface de linha de comando para gerenciar as regras de iptables.

        Iptables: Ferramenta nativa do kernel Linux para filtragem de pacotes e NAT (Network Address Translation).

    Proxy Web:

        Squid: Servidor proxy de alto desempenho para web, configurado para cache e modo transparente.

üó∫Ô∏è Topologia de Rede (Conceitual)

A m√°quina Debian atua como um ponto de acesso √∫nico entre a internet e a rede local.

       Internet (WAN)
             |
             | (eth1)
     [Servidor Debian 12]
     (Firewall/Roteador/Proxy)
             | (eth0)
             |
       Rede Local (LAN)
             |
      [Dispositivos Clientes]
      (PCs, Laptops, Smartphones, etc.)

    eth0: Interface de rede conectada √† sua rede local (LAN), com um IP est√°tico (ex: 192.168.1.1).

    eth1: Interface de rede conectada ao seu modem/ISP (WAN), obtendo IP via DHCP ou est√°tico.

‚öôÔ∏è Guia de Configura√ß√£o Passo a Passo

Siga estes passos para configurar seu Debian 12:
1. Prepara√ß√£o Inicial do Debian

Certifique-se de que o sistema est√° atualizado e que as interfaces de rede est√£o configuradas corretamente (uma para LAN e outra para WAN).

sudo apt update
sudo apt upgrade -y

2. Ativar Encaminhamento de IP (IP Forwarding)

Para que o Debian roteie o tr√°fego entre a LAN e a WAN, o encaminhamento de IP deve estar ativo.

    Edite o arquivo de configura√ß√£o do kernel:

    sudo nano /etc/sysctl.conf

    Descomente (remova o #) a seguinte linha, ou adicione-a se n√£o existir:

    net.ipv4.ip_forward=1

    Salve (Ctrl+O) e saia (Ctrl+X).

    Aplique a mudan√ßa imediatamente:

    sudo sysctl -p

3. Instala√ß√£o e Configura√ß√£o do Squid (Proxy Transparente)

O Squid ser√° instalado e configurado para interceptar o tr√°fego HTTP de forma transparente.

    Instalar o Squid:

    sudo apt install squid -y

    Fazer backup do arquivo de configura√ß√£o original:

    sudo cp /etc/squid/squid.conf /etc/squid/squid.conf.original

    Editar o arquivo de configura√ß√£o do Squid:

    sudo nano /etc/squid/squid.conf

    Realize as seguintes modifica√ß√µes:

        Porta de Escuta para Proxy Transparente:

        Altere ou adicione esta linha para a porta que o Squid ir√° escutar, com a op√ß√£o transparent.

        http_port 3128 transparent

        Definir ACL da Rede Local:

        Substitua 192.168.1.0/24 pela sua faixa de IP da LAN.

        acl localnet src 192.168.1.0/24

        Permitir Acesso √† Rede Local:

        A ordem √© crucial. Certifique-se de que http_access allow localnet venha antes de http_access deny all.

        http_access allow localnet
        http_access deny all

        Configurar o Cache (Opcional, mas recomendado):

        Descomente ou adicione esta linha para ativar o cache. 100 √© o tamanho em MB.

        cache_dir ufs /var/spool/squid 100 16 256

        Definir um Hostname Vis√≠vel (Opcional):

        visible_hostname meu_homelab_firewall

    Salvar (Ctrl+O) e Sair (Ctrl+X).

    Reiniciar o servi√ßo Squid:

    sudo systemctl restart squid

4. Configura√ß√£o do UFW (Uncomplicated Firewall)

O UFW facilitar√° a gest√£o das regras de iptables e ser√° o principal ponto de controle do firewall.

    Instalar o UFW:

    sudo apt install ufw -y

    Permitir acesso SSH (essencial para evitar bloqueios):

    sudo ufw allow ssh

    Ativar o UFW:

    sudo ufw enable

    Voc√™ pode ser avisado sobre SSH e conex√µes existentes. Confirme (y).

5. Adicionar Regras Iptables para NAT e Proxy Transparente via UFW

As regras mais complexas (NAT e redirecionamento transparente para o Squid) s√£o adicionadas diretamente nos arquivos de regras do UFW para persist√™ncia.

    Editar o arquivo before.rules do UFW:

    Este arquivo √© processado antes das regras padr√£o do UFW e √© o local ideal para as regras de PREROUTING e POSTROUTING.

    sudo nano /etc/ufw/before.rules

    Adicionar Regra de NAT (Masquerading):

    No final da se√ß√£o *nat (antes do COMMIT final dessa se√ß√£o), adicione a regra de MASQUERADE. Substitua eth1 pela sua interface WAN.

    # NAT (Masquerading) para acesso √† Internet
    -A POSTROUTING -o eth1 -j MASQUERADE

    Adicionar Regra de Redirecionamento para o Squid (Proxy Transparente):

    No final da se√ß√£o *nat (antes do COMMIT final dessa se√ß√£o), adicione a regra de PREROUTING. Substitua eth0 pela sua interface LAN e 3128 pela porta do Squid.

    # Redirecionamento de HTTP para Squid (Proxy Transparente)
    -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3128

    (Nota: Para HTTPS transparente (SSL Bump), regras adicionais para a porta 443 seriam necess√°rias, juntamente com a configura√ß√£o do Squid para SSL Bump, que √© um t√≥pico mais avan√ßado e possui implica√ß√µes de seguran√ßa.)

    Verificar e Salvar:

    Certifique-se de que cada bloco *tabela (ex: *nat, *filter) termina com um COMMIT. Se voc√™ adicionar regras e n√£o houver um COMMIT no final da tabela correspondente, o UFW pode falhar ao carregar as regras.

    Salve (Ctrl+O) e Saia (Ctrl+X).

    Recarregar o UFW para aplicar as novas regras:

    sudo ufw disable
    sudo ufw enable

‚úÖ Verifica√ß√£o da Configura√ß√£o

Ap√≥s todos os passos, √© crucial verificar se tudo est√° funcionando como esperado:

    Verificar o status do Squid:

    sudo systemctl status squid

    Deve indicar active (running).

    Monitorar os logs do Squid:

    Acompanhe o tr√°fego que passa pelo proxy.

    sudo tail -f /var/log/squid/access.log

    Testar a navega√ß√£o nos dispositivos clientes:

    Os dispositivos conectados √† sua LAN devem conseguir acessar a internet normalmente, sem qualquer configura√ß√£o manual de proxy no navegador. O tr√°fego HTTP deve aparecer no access.log do Squid.

üìà Melhorias Futuras (Roadmap)

Este setup b√°sico pode ser expandido com as seguintes funcionalidades:

    Filtragem de Conte√∫do: Implementar bloqueio de sites indesejados ou categorias de conte√∫do usando as ACLs do Squid e/ou integra√ß√£o com listas de bloqueio externas.

    Autentica√ß√£o de Usu√°rios: Configurar autentica√ß√£o no Squid para controlar e registrar o acesso de usu√°rios espec√≠ficos.

    Monitoramento Avan√ßado: Integrar ferramentas como sarg ou lightsquid para gerar relat√≥rios detalhados de uso do proxy.

    Servi√ßos Adicionais: Adicionar outros servi√ßos ao homelab, como um servidor DNS (Bind9 ou Pi-hole), DHCP, ou VPN.

    Configura√ß√£o de HTTPS Transparente (SSL Bump): Para interceptar e cachear tr√°fego HTTPS, compreendendo as implica√ß√µes de seguran√ßa e privacidade.

Sinta-se √† vontade para clonar este reposit√≥rio, testar a configura√ß√£o e contribuir com melhorias!

